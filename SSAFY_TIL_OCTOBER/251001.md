---

## 251001

---

### [Objectives_ 학습 목표]

- logout 함수를 사용하여 로그아웃 기능을 구현할 수 있음
- 커스텀 User 모델을 위한 UserCreationForm을 작성함
- get_user_model 함수로 활성화된 User 모델을 참조함
- 커스텀 회원가입 폼을 활용하여 회원가입 기능을 구현함
- request.user.delete를 호출하여 회원 탈퇴 기능을 구현함
- is_authenticated 속성으로 인증 여부에 따라 접근을 제어함
- login_required 데코레이터로 인증된 사용자만 접근을 허용함

---

### [Build_ 이론]

### Login

: 클라이언트와 서버 간의 상태 정보를 유지하기 위해 쿠키와 세션을 사용

: 클라이언트와 서버는 각기 다른 사용자를 식별해야 하는 상태

: 서버에 “나”임을 인증하는 과정이 바로 “Login”

→ Login은 인증(id/password)을 완료하고, Session을 만들고 클라이언트와 연결하는 것

![image.png](attachment:cd2a6ea3-e435-44b5-ba98-5e670efa1f07:image.png)

**로그인 페이지 작성**

- 로그인 경로 url 생성

![image.png](attachment:fc291265-1dd0-48e6-ae28-7ccdb4b1c736:image.png)

- …/accounts/login/ url로 요청이 들어왔을 때 실행할 login 함수 작성
- 로그인 인증에 사용할 데이터를 입력 받는 built-in form(AuthenticationForm) 사용

![image.png](attachment:1f2275cb-a6ed-4c38-9eb2-650eaec06fb2:image.png)

✅AuthenticationForm()

: 로그인 인증에 사용할 데이터를 입력 받는 built-in form

: User 모델과 직접 연결된 ‘ModelForm’이 아닌, 일반 ‘Form’을 상속 받음

→ 일반 ‘Form’이기 때문에 사용자를 생성하거나 수정하는 용도가 아닌 ‘인증’하는 역할만 수행

![image.png](attachment:84c5a5f6-70cd-4790-98bc-14aaf5c44928:image.png)

- 로그인 정보를 서버에 안전하게 전송하기 위해 “POST 방식”을 사용
- CSRF 공격을 방지하기 위해  csrf_token 작성
- 서버로부터 전달받은 AuthenticationForm을 화면에 출력

![image.png](attachment:03179dbf-35e1-4444-9f11-e99ed4bb023a:image.png)

- 사용자가 입력한 로그인 정보를 입력받는 로직을 “POST” 조건문에 작성
- 입력 받은 정보를 기반으로 로그인하여 세션을 만드는 ‘login’ 함수를 활용

![image.png](attachment:6465e037-234a-4e51-8225-54627665f1ee:image.png)

**login(request, user)**

: AuthenticationForm을 통해 인증된 사용자를 로그인하는 함수

- request
    
    : 현재 사용자의 세션 정보에 접근하기 위해 사용
    
- user
    
    : 어떤 사용자가 로그인 되었는지를 기록하기 위해 사용
    

**get_user()**

: AuthenticationForm의 인스턴스 메서드

→ 유효성 검사를 통과했을 경우, 로그인 한 사용자 객체를 반환

![image.png](attachment:5ae1abdb-9cfe-4ba1-ba0c-e185871f46d1:image.png)

**세션 데이터 확인하기**

1. 로그인 후 발급받은 세션 확인
    1. django_session 테이블에서 확인
    
    ![image.png](attachment:bd5005a7-0257-4273-a44e-57f5e1fb650d:image.png)
    
2. 브라우저에서 확인
    1. 개발자 도구 - Application - Cookies
    
    ![image.png](attachment:7d9cf79f-3df8-40a6-8279-8a14fb9f9774:image.png)
    

**로그인 링크 작성**

: 메인 페이지에 로그인 페이지로 갈 수 있는 링크 작성

![image.png](attachment:0f198540-0490-4e36-80ba-6471750bd134:image.png)

![image.png](attachment:50f10bbd-ea70-486c-a3c8-2c7e581b40ef:image.png)

### Template with Authentication data

: 템플릿에서 인증 관련 데이터를 출력하는 방법

**현재 로그인 되어있는 유저 정보 출력하기**

- user라는 context 데이터를 사용할 수 있는 이유?
    
    → django가 미리 준비한 context 데이터가 존재하기 때문(context processors)
    
    ![image.png](attachment:7c0d578f-13fb-4d79-a7ae-107712d59393:image.png)
    
- context processors
    
    : 템플릿이 렌더링 될 때 호출 가능한 컨텍스트 데이터 목록
    
    : 작성된 컨텍스트 데이터는 기본적으로 템플릿에서 사용 가능한 변수로 포함됨
    
    : django에서 자주 사용하는 데이터 목록을 미리 템플릿에 로드해 둔 것
    
    ![image.png](attachment:5b2508cf-4677-417b-842b-122e2ce889df:image.png)
    

### Logout

: Session을 Delete하는 과정

: 서버의 세션 데이터를 비우고, 클라이언트의 세션 쿠키 삭제

**logout(request)**

: DB에서 현재 요청에 대한 Session Data를 삭제

: 클라이언트의 쿠키에서도 Session Id를 삭제

**로그아웃 로직 작성**

- 로그아웃 경로 url 생성

![image.png](attachment:c9dddabb-d74f-4140-9c3d-138179681e93:image.png)

- …/accounts/logout/ url로 요청이 들어왔을 때 실행할 logout 함수 작성
- DB에서 현재 요청에 대한 Session Data를 삭제하고, 클라이언트 쿠키에서도 Session Id를 삭제하는 내장 logout 함수 작성

![image.png](attachment:3471aecb-a042-42cc-958a-f26b7f49dc46:image.png)

- 로그인한 사용자 정보를 서버에 안전하게 전송하기 위해 “POST 방식”을 사용
- CSRF 공격을 방지하기 위해 csrf_token 작성

![image.png](attachment:70ea3d64-de5b-4914-8e00-f245eb9d7f91:image.png)

### AbstractUser class

**Abstract base classes(추상 기본 클래스)**

: 몇 가지 공통 정보를 여러 다른 모델에 넣을 때 사용하는 클래스

: 데이터 베이스 테이블을 만드는 데 사용되지 않으며, 대신 다른 모델의 기본 클래스로 사용되는 경우 해당 필드가 하위 클래스의 필드에 추가 됨

: 인증에 필요한 최소한의 기능만 제공

**AbstractUser class**

: 관리자 권한과 함께 완전한 기능을 가지고 있는 User model을 구현하는 추상 기본 클래스

: 기본 User 모델이 가진 모든 필드가 이미 구현되어 있음

![image.png](attachment:1e65fa30-eadc-431a-9dee-6698a59ba104:image.png)

**추상 기본 클래스(Abstract Base Class) 정리**

- AbstractBaseUser
    - 제공 필드 : 최소한의 인증 필드(비밀번호, last_login 등)
    - 장점 : 최대의 유연성과 자유도
    - 사용 케이스 : 이메일이 아닌 전화번호 등으로 로그인하는 등, 완전히 새로운 인증 체계를 만들 때
    - 예시 : 기본 피자 도우
- AbstractUser
    - 제공 필드 : 기본 User 모델의 모든 필드(username, email 등)
    - 장점 : 개발 속도가 빠르고 편리함
    - 사용 케이스 : 기존 인증 방식은 유지하면서 프로필 사진, 닉네임 등 필드만 추가하고 싶을 때(대부분의 경우)
    - 예시 : 토핑이 올려진 피자
    
    ![image.png](attachment:c54926d3-4b0e-4958-a093-d33a310dc183:image.png)
    

### 회원 가입

: User 객체를 Create하는 과정

: 사용자로부터 아이디, 비밀번호 등의 정보를 입력 받아, DB에 새로운 User 객체를 생성하고 저장

![image.png](attachment:79d93dac-60f4-4d86-9bba-86d1e80bd8b2:image.png)

**회원 가입 페이지 작성**

- 회원가입 경로 url 생성
    
    ![image.png](attachment:0c2704b3-159c-4ccb-86d1-a00bd0387881:image.png)
    
- …/accounts/signup/ url로 요청이 들어왔을 때 실행할 signup 함수 작성
- 회원가입에 사용할 데이터를 입력 받는 UserCreationForm built-in form 사용
    
    ![image.png](attachment:7ddf051e-9d66-4698-9960-46e3e87f0896:image.png)
    
    - UserCreationForm()
        - 회원 가입 시 사용자 입력 데이터를 받는 built-in ModelForm
        - ModelForm이기 때문에, 유효성 검사를 통과한 데이터로 새로운 User 객체를 생성하고 데이터 베이스에 저장하는 역할을 수행(이때 비밀번호는 자동으로 암호화 됨)
        
        ![image.png](attachment:84e6fa0e-48d7-491a-86e4-97733d4727d2:image.png)
        
- 회원가입을 위해 작성한 정보를 서버에 안전하게 전송하기 위해 “POST 방식”을 사용
- CSRF 공격을 방지하기 위해 csrf_token 작성
- 서버로부터 전달받은 UserCreationForm을 화면에 출력
    
    ![image.png](attachment:c2f90e43-2842-4f3b-af4a-a5ebcfa5d6b4:image.png)
    

**회원 가입 로직 에러**

- 회원가입 시도 후 에러 페이지 확인
    
    → Manager isn’t available; ‘auth.User’ has been swapped for ‘accounts.User’
    
    ![image.png](attachment:a2caa4e1-2a54-4071-a3f9-0f472df0c517:image.png)
    
- 회원가입에 사용하는 UserCreationForm이 대체한 커스텀 유저 모델이 아닌 과거 Django의 기본 유저 모델로 인해 작성된 클래스이기 때문
    
    → model에 Custom User Model을 연결!
    
    ![image.png](attachment:798e934a-8c91-41f7-a5e5-31e541db5348:image.png)
    
- 커스텀 유저 모델을 사용하기 위해 Form을 다시 작성
    - Custom User Model을 사용할 수 있도록 상속 후 일부분만 재작성
        
        ![image.png](attachment:cc3433d6-d4c5-4680-b8fb-a740faf8b119:image.png)
        
    - get_user_model()
        
        : 현재 프로젝트에서 활성화된 사용자 모델(active user model)을 반환하는 함수
        
        → 프로젝트 설정(AUTH_USER_MODEL)에 따라 기본 User 모델일 수도, 우리가 직접 만든 커스텀 User 모델일 수도 있기 때문에 올바른 모델을 동적으로 가져오기 위해 사용함
        
        → 모델을 직접 가져오는 대신 get_user_model()을 쓰면, User 모델이 바뀌어도 코드를 수정할 필요가 없어 재사용성과 유연성이 높아짐
        
    - User모델을 직접 참조하지 않는 이유
        - get_user_model()을 사용해 User 모델을 참조하면 커스텀 User 모델을 자동으로 반환해주기 때문
        - Django는 필수적으로 User 클래스를 직접 참조하는 대신 get_user_model()을 사용해 참조해야 한다고 강조하고 있음
        
        ![image.png](attachment:a141d60f-3b3a-4b1c-96bc-5138ba8277f8:image.png)
        
- 회원 가입 로직 완성
    - 내장 폼이였던 UserCreationForm을 CustomUserCreationForm으로 변경
    
    ![image.png](attachment:06376d88-e85e-4db8-b2d2-fbf6f51d5a8d:image.png)
    

### 회원 탈퇴

: User 객체를 Delete하는 과정

: request.user.delete()를 활용해서 유저 객체 삭제를 진행

→ 실제 서비스에서는 사용자를 물리적으로 삭제하는 대신, 계정을 비활성화 처리하는 경우가 더 많음

**회원 탈퇴 로직 작성**

- 회원 탈퇴 경로 url 생성
    
    ![image.png](attachment:274d921a-0ca2-4535-8f18-70a00a46c33f:image.png)
    
- …/accounts/delete/ url로 요청이 들어왔을 때 실행할 delete 메서드 작성
- 현재 로그인한 사용자 정보를 활용해 삭제하고, 메인 페이지로 이동

![image.png](attachment:c600accc-0fb3-4967-867f-1dd37ee7d49c:image.png)

### 인증된 사용자에 대한 접근 제한

1. is_authenticated 속성
    
    : 사용자가 인증되었는지 여부를 알 수 있는 User model의 읽기 전용 속성
    
    : 인증 사용자에 대해서는 항상 True, 비인증 사용자에 대해서는 항상 False
    
    - 사용되는 경우
        - 사용자의 로그인 상태에 따라 다른 메뉴를 보여줄 때
        - view 함수 내에서 특정 기능을 로그인한 사용자에게만 허용하고 싶을 때
    - is_authenticated 적용하기
        - 로그인과 비로그인 상태에서 화면에 출력되는 링크를 다르게 설정하기
            
            ![image.png](attachment:d06bce7d-c66a-439b-a095-067716c7b039:image.png)
            
        - 인증된 사용자라면 로그인/회원가입 로직을 수행할 수 없도록 하긴
            
            ![image.png](attachment:9ec4a452-a4cb-48e9-99e2-e5383adf935b:image.png)
            
2. login_required 속성
    
    : 인증된 사용자에 대해서만 view 함수를 실행시키는 데코레이터
    
    : 비인증 사용자의 경우 /accounts/login/ 주소로 redirect 시킴
    
    - 사용되는 경우
        - 게시글 작성, 댓글 달기 등 누가 작성했는지 중요한 곳에서 사용
    - login_required 적용하기
        - 인증된 사용자만 게시글을 작성/수정/삭제할 수 있도록 수정
            
            ![image.png](attachment:28940128-c285-4c3e-88a5-1bc37efd8632:image.png)
            
        - 인증된 사용자만 로그아웃/탈퇴/수정/비밀번호 변경할 수 있도록 수정
            
            ![image.png](attachment:45771cf5-6271-4f9a-91f8-13a3528d2a3e:image.png)