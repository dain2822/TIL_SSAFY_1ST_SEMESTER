## 251106

### [Objectives_ 학습 목표]

- User와 Article, User와 Comment 모델 간의 N : 1 관계를 정의할 수 있음
- 인증된 사용자만 게시글 / 댓글을 작성하거나 삭제할 수 있도록 구현할 수 있음
- Django의 ORM을 활용해 CREATE/READ/UPDATE/DELETE 기능을 실습할 수 있음
- View deocrators를 통해 HTTP 요청 방식에 따라 기능을 제어할 수 있음
- ERD를 활용해 모델 관계 구조를 시각적으로 표현하고 설명할 수 있음

---

### [Build_ 이론]

### Article & User

### 모델 관계 설정

**Article - User 모델 관계 설정**

- User 외래 키 정의
    
    ![image.png](attachment:1330d6f7-6e0b-467b-8de3-52d85f756159:image.png)
    
- User 모델을 직접 Import 하지 않는 이유
    - Article 클래스 생성 시점이 User 클래스 시점보다 빠른 경우 외래 키 설정에서 참고할 User 모델을 찾지 못해 에러가 발생할 수 있음
    - models.py에서는 안정적인 참조가 필요하기 때문에 settings.AUTH_USER_MODEL의 값을 사용함
    

**User 모델을 참조하는 2가지 방법**

- settings.AUTH_USER_MODEL
    - settings.py에서 정의된 AUTH_USER_MODEL 설정 값을 가져옴
    - 반환 값 : ‘accounts.User’(문자열)
    - models.py에서 User 모델을 참조할 때 주로 사용
- get_user_model()
    - 현재 settings.py에 정의되어 활성화된 User 모델을 가져옴
    - 반환 값 : User Object(객체)
    - models.py를 제외한 다른 모든 위치에서 사용

- settings.AUTH_USER_MODEL의 반환 값이 문자열이어도 괜찮은 이유
    
    : 모델의 경로 형태인 문자열이 ForeignKey의 참조 모델로 설정되면, Django에서 내부적으로 해당 모델이 완전히 로딩된 후 모델 클래스를 가져와 처리하는 지연평가(lazy evaluation)방식으로 동작하기 때문임
    

**Migration**

- 기존에 테이블이 있는 상황에서 필드를 추가하려고 하기 때문에 발생하는 과정
- 기본적으로 모든 필드에는 NOT NULL 제약 조건이 설정되어 있어, 데이터 없이 새로운 필드를 추가할 수 없음
- ‘1’을 입력하고 Enter 진행(다음 화면에서 직접 기본 값 입력)
    
    ![image.png](attachment:9616ea1e-9d7a-4214-b210-a10270d0fcf7:image.png)
    
- 추가하는 외래 키 필드에 어떤 데이터를 넣을 것인지 직접 입력해야 함
- 마찬가지로  ‘1’을 입력하고 Enter 진행
    
    → 기존에 작성된 게시글이 있다면 모두 1번 회원이 작성한 것으로 처리됨
    
    ![image.png](attachment:1749d148-ec5f-4cf2-a9be-bc30871cb79e:image.png)
    
    → 1번 회원이 없는 경우 migrate시 에러 발생
    
- migrations 파일 생성 후 migrate 진행
    
    ![image.png](attachment:3efc365d-d7c8-41b8-a012-864d79939b02:image.png)
    
- articles_article 테이블에 user_id 필드 생성 확인
    
    ![image.png](attachment:bbc0ebe9-201e-4f96-9e52-89f0ae2e451e:image.png)
    

### 게시글 CREATE

**게시글 CREATE 구현**

- 새 게시글 작성 시 ArticleForm 출력 변화 확인
    
    : 새롭게 추가된 ForeignKey 필드인 User 필드 확인됨
    
- User 모델에 대한 사용자 입력 창이 나오지만 사용자가 입력하지 않아야 하는 입력
    
    : 다른 사람을 선택하게 되면 사칭에 대한 문제가 발생할 수 있음
    
    ![image.png](attachment:c00f23fd-b00d-4fb3-b4d6-1e70a76cefab:image.png)
    
- 기존 ArticleForm에서 사용자가 입력할 수 있는 필드를 변경
    
    : 글 작성자는 사용자가 선택하지 않아도 되는 정보
    
- 사용자는 게시글 제목과 내용만 입력하도록 수정
    
    ![image.png](attachment:9ea5a3a7-9f47-4c54-9661-7b961485e675:image.png)
    
- 게시글을 작성하면 아래와 같이 에러가 발생
    
    : NOT NULL constraint failed: articles_article.user_id
    
    → user_id 필드 데이터가 누락되어 NOT NULL 제약 조건에 위배
    
    ![image.png](attachment:5122eb2e-fa00-4997-9117-963296a6f772:image.png)
    
- 게시글 작성 시 작성자 정보가 함께 저장될 수 있도록 save의 commit 옵션 활용
    
    : 게시글 작성자는 현재 글을 작성하는 로그인 된 사용자(request.user) 정보를 저장ㄴ
    
    ![image.png](attachment:af81b159-56df-4537-90e8-18cdb175e5ce:image.png)
    
- 게시글 작성 후 데이터베이스 articles_article 테이블 확인
    
    ![image.png](attachment:1f7bb912-1870-476d-963e-0868fd6accde:image.png)
    
    → 로그인한 User에 따라 저장되는 User PK가 다를 수 있음을 유의
    

### 게시글 READ

**게시글 READ 구현**

- index 페이지에 게시글 작성자 정보 출력하도록 수정
    
    ![image.png](attachment:d1e128dd-0c85-432e-8b80-dc27b813dc49:image.png)
    
- 각 게시글 상세 페이지에도 작성자 정보 출력하도록 수정
    
    ![image.png](attachment:954f19d2-7666-4846-8cbd-1e74e4a5addd:image.png)
    

### 게시글 UPDATE

**게시글 UPDATE 구현**

- 게시글 수정 요청 사용자와 게시글 작성 사용자를 비교하여 본인의 게시글만 수정할 수 있도록 하기
    
    ![image.png](attachment:af9aa6c1-a772-4f43-9c5a-f2e405d51b2b:image.png)
    
- 해당 게시글의 작성자가 아니라면, 수정/삭제 버튼을 출력하지 않도록 하기
    
    ![image.png](attachment:1639cff9-faff-4dc1-bc9e-58ad0e22c241:image.png)
    

### 게시글 DELETE

**게시글 DELETE 구현**

- 삭제를 요청하려는 사람과 게시글을 작성한 사람을 비교하여 본인의 게시글만 삭제할 수 있도록 하기
    
    ![image.png](attachment:832ba9e0-0434-44d1-93d5-a91033f40fc4:image.png)
    
- [views.py](http://views.py)에서 또 사용자를 구분하여 처리하는 이유
    - 요청을 보내는 방법은 브라우저만 있는 것이 아니기 때문에 내부에서도 반드시 처리가 필요함
    - requests 패키지 혹은 postman 어플을 이용한 요청은 브라우저를 통하지 않기 때문에 내부에서 사용자 구분을 해야 함

---

### Comment & User

### 모델 관계 설정

**Comment - User 모델 관계 설정**

- User는 여러 개의 댓글을 작성
- Comment는 한 명의 작성자가 작성
- Comment 모델 클래스에 User 필드를 참조하도록 외래 키(ForeignKey) 설정
    
    ![image.png](attachment:c2176382-1fc7-4b98-a5bb-04835b09aa73:image.png)